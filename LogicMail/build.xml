<?xml version="1.0" encoding="UTF-8"?>
<!--
 Ant build file for the LogicMail application
-->
<project name="LogicMail" default="build" basedir=".">
    <!-- Properties -->
    <property name="src.dir" location="src"/>
    <property name="dist.dir" location="dist"/>
	<property file="project.properties"/>

    <!-- Task definitions -->
    <taskdef name="rapc" classname="ca.slashdev.bb.RapcTask">
        <classpath>
            <pathelement location="../lib/bb-ant-tools.jar"/>
        </classpath>
    </taskdef>
    <taskdef name="xmltask" classname="com.oopsconsultancy.xmltask.ant.XmlTask">
        <classpath>
            <pathelement location="../lib/xmltask.jar"/>
        </classpath>
    </taskdef>

	<!-- Build the application -->
    <target name="build">
        <mkdir dir="${dist.dir}"/>
        <copy file="${src.dir}/icons/logicmail.png" todir="${dist.dir}"/>
        <rapc output="${module.name}"
              srcdir="${src.dir}"
              destdir="${dist.dir}"
              jdehome="${jde.home}">
              <jdp title="${module.title}"
                 vendor="${module.vendor}"
                 version="${module.version}"
                 type="cldc"
                 midletclass="org.logicprobe.LogicMail.LogicMail"
                 icon="logicmail.png"/>
            <src>
                <fileset dir="${src.dir}">
                    <include name="**/*.java"/>
                	<include name="**/*.rrc"/>
                	<include name="**/*.rrh"/>
					<exclude name="**/bb40"/>
					<exclude name="**/*BB40.java"/>
                    <include name="**/*.png"/>
                </fileset>
            </src>
        </rapc>
        <delete file="${dist.dir}/logicmail.png"/>
	</target>

	<!-- Load the build output into the simulator -->
	<target name="load-simulator" depends="build">
		<copy todir="${simulator.home}">
			<fileset dir="${dist.dir}" includes="*.cod,*.csl,*.cso,*.debug,*.jar"/>
		</copy>
	</target>
	
	<!-- Run the application in the simulator -->
	<target name="run-simulator" depends="load-simulator">
		<exec
			dir="${simulator.home}"
			executable="${simulator.home}/${simulator.exec}"
			spawn="true"/>
	</target>

	<!-- Prepare the distribution -->
	<target name="dist" depends="build">
        <!-- Modify and copy the ALX file -->
        <xmltask
            source="LogicMail.alx"
            dest="${dist.dir}/${module.name}.alx">
			<replace path="loader/application/version/text()" withText="${module.version}"/>
			<replace path="loader/application/fileset/files/text()" withText="${module.name}.cod"/>
        </xmltask>

        <!-- Create the distribution archive -->
		<zip destfile="${dist.dir}/LogicMail-${module.version}.zip">
            <fileset dir="${dist.dir}" includes="*.jar, *.jad, *.cod, *.alx"/>
            <fileset dir=".." includes="README.txt, LICENSE.txt, ChangeLog.txt"/>
        </zip>

		<!-- Prepare the OTA installation files -->
        <mkdir dir="${dist.dir}/ota"/>
        <unzip
            src="${dist.dir}/${module.name}.cod"
            dest="${dist.dir}/ota"/>
		<copy todir="${dist.dir}/ota">
			<fileset dir="${dist.dir}" includes="*.jar, *.jad"/>
		</copy>
	</target>

	<target name="clean">
		<delete dir="${dist.dir}"/>
	</target>
</project>
